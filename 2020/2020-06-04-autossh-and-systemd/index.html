<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Jukka Aho (@ahojukka5)  | SSH-tunnelin pitäminen ylhäällä autossh:lla</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css" />
    <link rel="stylesheet" href="https://ahojukka5.github.io/css/blog.css" />
    </head>
<body>

    
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="https://ahojukka5.github.io">Home</a>
        </div>
    </nav>
    

    
    <section class="hero is-info is-medium">
        <div class="hero-body" style="background-image: url(https://ahojukka5.github.io/img/bg-blog.jpg);">
            <div class="container has-text-centered">
                <br>
                <h1 class="title is-size-1">
                    
                        SSH-tunnelin pitäminen ylhäällä autossh:lla
                    
                </h1>
                
            </div>
        </div>
    </section>


<div class="container">
    <div class="section">
    

<div class="columns">
    <div class="column is-9">
        <div class="tile is-child box">
            <div class="content">
                <p>Pätkivissä internet-yhteyksissä ssh-tunnelien pitäminen ylhäällä voi osoittautua
melko työlääksi touhuksi. Tämän ongelman voi kuitenkin ratkaista käynnistämällä
autossh-ohjelman systemd:llä. Tällä tavalla tunneli luodaan automaattisesti kun
tietokone käynnistetään sekä pidetään ylhäällä aina kun intenert-yhteys löytyy.</p>
<p>Tiedostoon <code>/etc/systemd/system/autossh@.service</code>:</p>
<pre><code class="language-conf" data-lang="conf">[Unit]
Description=Keeps an ssh tunnel to %I open
After=network-online.target ssh.service

[Service]
User=tunnel
# no monitoring
Environment=&quot;AUTOSSH_PORT=0&quot;
# Disable gatetime behaviour
Environment=&quot;AUTOSSH_GATETIME=0&quot;
EnvironmentFile=/etc/default/autossh@%i
RestartSec=3
Restart=always

# -NT Just open the connection and do nothing (not interactive, no tty alloc)
# use /usr/bin/ssh instead of autossh is good as well
ExecStart=/usr/bin/autossh -NT -o &quot;ExitOnForwardFailure=yes&quot; $SSH_OPTIONS ${TARGET_HOST} $FORWARDS
TimeoutStopSec=10

[Install]
WantedBy=multi-user.target
</code></pre><p>Tässä siis luetaan ympäristön konfiguraatio tiedostosta
<code>/etc/default/autossh@%i</code>, missä <code>i</code> on jokin merkkijono, esimerkiksi
ssh-palvelun nimi. Ympäristön konfiguraatio taas on seuraava:</p>
<pre><code class="language-conf" data-lang="conf"># Options for autossh@host1.service
# Place it at /etc/default

# Save all your credential/user/port related config in ~/.ssh/config is strongly recommanded
# Leave hostname here only
TARGET_HOST=kayttajatunnus@domain.com

# -L LOCALPORT:IP_ON_EXAMPLE_COM:PORT_ON_EXAMPLE_COM
# can set multiple forwardings here
FORWARDS=-D8080

# === Settings below for ADVANCED users only ===

SSH_OPTIONS=-o &quot;ServerAliveInterval=180&quot; -o &quot;ServerAliveCountMax=60&quot;
AUTOSSH_PORT=0
AUTOSSH_GATETIME=0
</code></pre><p>Tässä tapauksessa tehdään dynaaminen tunneli porttiin 8080 (SOCKS). Eli komento
joka lopulta suoritetaan on:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/usr/bin/autossh -NT -o <span style="color:#e6db74">&#34;ExitOnForwardFailure=yes&#34;</span> -o <span style="color:#e6db74">&#34;ServerAliveInterval=180&#34;</span> -o <span style="color:#e6db74">&#34;ServerAliveCountMax=60&#34;</span> kayttajatunnus@domain.com -D8080
</code></pre></div><p>Vastaavalla tavalla voidaan rakentaa SSH-tunneli esimerkiksi serverin
MySQL-tietokantaan, mikäli vain lokaalit yhteydet on sallittu, mikä
tyypillisesti on tilanne.</p>
<p>Tunnelin tilaa voidaan tarkastaa ja säätää <code>systemctl</code>-komennolla. Tunnelin
automaattinen käynnistys kun tietokone käynnistetään:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl enable autossh@palvelun_nimi
</code></pre></div><p>Tunnelin käynnistys välittömästi:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl start autossh@palvelun_nimi
</code></pre></div><p>Tunnelin tilan tarkastus:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl status autossh@palvelun_nimi
</code></pre></div>
            </div>
        </div>
    </div>
    <div class="column is-3">
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Tags</h1>
        <div class="tags">
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/autossh">autossh</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/bash">bash</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/c&#43;&#43;">c&#43;&#43;</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/deep-learning">deep-learning</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/duplicity">duplicity</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/filters">filters</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/gmsh">gmsh</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/juliafem">juliafem</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/jupyter-notebook">jupyter-notebook</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/linux">linux</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/lstm-networks">lstm-networks</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/pandoc">pandoc</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/parametric-simulations">parametric-simulations</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/partial-differential-equations">partial-differential-equations</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/ssh-tunnel">ssh-tunnel</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/systemd">systemd</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/verify">verify</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/vibration-data">vibration-data</a></span>
        
            <span class="tag"><a href="https://ahojukka5.github.io/tags/wrapping">wrapping</a></span>
        
        </div>          
    </div>
</div><br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Recent posts</h1>
        
            <h1><a href="https://ahojukka5.github.io/2020/2020-06-05-get-latest-file-name/">Uusimman tiedoston löytäminen</a></h1>
            <time class="has-text-grey-light is-size-7">5 June 2020</time>
        
            <h1><a href="https://ahojukka5.github.io/2020/2020-06-04-backup-verification/">Varmuuskopioiden varmentaminen</a></h1>
            <time class="has-text-grey-light is-size-7">4 June 2020</time>
        
            <h1><a href="https://ahojukka5.github.io/2020/2020-06-04-autossh-and-systemd/">SSH-tunnelin pitäminen ylhäällä autossh:lla</a></h1>
            <time class="has-text-grey-light is-size-7">4 June 2020</time>
        
            <h1><a href="https://ahojukka5.github.io/2020/makefile-ja-ymparistomuuttujat/">Makefile ja ympäristömuuttujat</a></h1>
            <time class="has-text-grey-light is-size-7">3 June 2020</time>
        
            <h1><a href="https://ahojukka5.github.io/2020/2020-05-31-pandoc-filters/">Pandocin suodattimien käyttö</a></h1>
            <time class="has-text-grey-light is-size-7">31 May 2020</time>
        
    </div>
</div>
    
<br>
                


    
<br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Archives</h1>
        
            <a href="https://ahojukka5.github.io/archives/2020">2020</a> (7)<br>
        
            <a href="https://ahojukka5.github.io/archives/2019">2019</a> (4)<br>
        
    </div>
</div>

    </div>
</div>


    </div>
</div>

<footer class="footer has-background-grey-darker has-text-white">
    <div class="content has-text-centered">
        <p>
            <span class="icon is-large"><a href="https://twitter.com/" class="mysocial" rel="me"><i class="fab fa-twitter fa-3x"></i></a></span>&nbsp;&nbsp;
            <span class="icon is-large"><a href="https://www.youtube.com/" class="mysocial" rel="me"><i class="fab fa-youtube fa-3x"></i></a></span>&nbsp;&nbsp;
            <span class="icon is-large"><a href="https://github.com/" class="mysocial" rel="me"><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;
            <br><br>
            Copyright &copy; Jukka Aho (@ahojukka5) 2020 - Theme by <a href="https://jeffprod.com" class="mysocial">JeffProd.com</a>
            - <a class="mysocial" href="https://ahojukka5.github.io/about">About</a>
        </p>
    </div>
</footer>

<script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>
</body>
</html>
